# ë¹„ëª¨ìˆ˜ê²€ì •
import numpy as np
from scipy.stats import rankdata, wilcoxon
import matplotlib.pyplot as plt
import seaborn as sns


'''
ë¹„ëª¨ìˆ˜ê²€ì •ì˜ ì¥ì 
1. ë¶„í¬ê°€ì •ì´ ì—†ë‹¤
2. ì´ìƒì¹˜ì— ë¯¼ê°í•˜ì§€ ì•Šë‹¤.
3. í†µê³„ëŸ‰ì´ ì§ê´€ì ì¸ ê²½ìš°ê°€ ë§ë‹¤.
4. ë°ì´í„°ì˜ í¬ê¸°ì— êµ¬ì• ë°›ì§€ ì•ŠëŠ”ë‹¤.
'''

# ë¹„ëª¨ìˆ˜ ê²€ì •ì„ ë§¤ë²ˆ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ìœ 
# ëª¨ìˆ˜ê²€ì •ì´ ë¹„ëª¨ìˆ˜ ê²€ì •ë³´ë‹¤ ê²€ì •ë ¥ì´ ë” ë†’ë‹¤.

'''
ë¹„ëª¨ìˆ˜ ê²€ì •ì— ëŒ€í•œ ê¸°ì´ˆ ì§€ì‹ë“¤
1. ë¹„ëª¨ìˆ˜ ê²€ì •ì€ ëª¨ìˆ˜ì˜ ì¤‘ì‹¬ì ì„ í‰ê· ì´ ì•„ë‹Œ ì¤‘ì•™ê°’ìœ¼ë¡œ ì„¤ì •í•¨.
2. ì¤‘ì•™ê°’ì— ëŒ€í•´ ê²€ì •í•œë‹¤.
3. ê·¸ë˜ì„œ, ëª¨ ì¤‘ì•™ê°’ì„ ë‚˜íƒ€ë‚´ëŠ” ê·¸ë¦¬ìŠ¤ ë¬¸ì(ğœ‚) ì—íƒ€ë¥¼ ì‚¬ìš©í•œë‹¤.
'''


# ê·€ë¬´ê°€ì„¤(H0): ğœ‚ = ğœ‚0 
# ëŒ€ë¦½ê°€ì„¤(H1): ğœ‚ â‰  ğœ‚0

# ì•ì—ì„œ ë°°ì› ë˜ t ê²€ì •ì˜ ê·€ë¬´ê°€ì„¤ê³¼ ëŒ€ë¦½ê°€ì„¤ í˜•íƒœì™€ ë¹„ìŠ·í•˜ì§€ë§Œ, 
# ëª¨í‰ê· ì´ ì•„ë‹Œ ëª¨ì¤‘ì•™ê°’ì— ëŒ€í•œ ê²€ì •ì´ë¼ëŠ” ê²ƒë§Œ ë‹¤ë¦…ë‹ˆë‹¤.


# ê²€ì • í†µê³„ëŸ‰ê³¼ í•µì‹¬ ì•„ì´ë””ì–´
# ìœŒì½•ìŠ¨ ìˆœìœ„í•© ê²€ì • í†µê³„ëŸ‰(Wilcoxon rank-sum test statistic)
# 1. ë‘ ì§‘ë‹¨ì˜ ë°ì´í„°ë¥¼ í•©ì¹œë‹¤.
# 2. ë‘ ì§‘ë‹¨ì„ í•©ì¹œ ë°ì´í„°ì— ëŒ€í•´ ìˆœìœ„ë¥¼ ë§¤ê¸´ë‹¤.
# 3. ë‘ ì§‘ë‹¨ì˜ ë°ì´í„°ì— ëŒ€í•´ ê°ê° ìˆœìœ„ë¥¼ ë§¤ê¸´ë‹¤.
# 4. ë‘ ì§‘ë‹¨ì˜ ìˆœìœ„í•©ì„ ê³„ì‚°í•œë‹¤.
# 5. ìˆœìœ„í•©ì„ ê¸°ì¤€ìœ¼ë¡œ ê²€ì • í†µê³„ëŸ‰ì„ ê³„ì‚°í•œë‹¤.
# 6. ê²€ì • í†µê³„ëŸ‰ì„ ê¸°ì¤€ìœ¼ë¡œ p-valueë¥¼ ê³„ì‚°í•œë‹¤.
# 7. p-valueë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê·€ë¬´ê°€ì„¤ì„ ê¸°ê°í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•œë‹¤.


# ë¬¸ì œ 1
# Ri ë“¤ì„ ëª¨ë‘ ë”í•˜ë©´ ? 
# n(n+1)/2 ê°€ ëœë‹¤.

# ìœŒì½•ìŠ¤ ìˆœìœ„í•© ê²€ì • í†µê³„ëŸ‰ ê²°ê³¼ í•´ì„


# ì˜ˆì‹œ (1í‘œë³¸ ê²€ì •)
# 1í‘œë³¸ ê²€ì •ì€ ë‹¨ì¼ ì§‘ë‹¨ì˜ ì¤‘ì•™ê°’ì´ íŠ¹ì • ê°’ê³¼ ê°™ì€ì§€ë¥¼ ê²€ì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
'''
$$
\psi_i = \psi(x_i - \eta_0) =
\begin{cases}
1 & \text{if } x_i - \eta_0 > 0 \\
0 & \text{otherwise}
\end{cases}
$$
'''
sample = np.array([9.76, 11.1, 10.7, 10.72, 11.8, 6.15, 10.52,
14.83, 13.03, 16.46, 10.84, 12.45])

eta_0 = 10
len(sample)

# Rië¥¼ ê³„ì‚°í•´ë³´ì
# eta_0ì—ì„œ ë–¨ì–´ì§„ ê±°ë¦¬ì˜ ìˆœìœ„ë¥¼ ê³„ì‚°í•œë‹¤.
ri = rankdata(np.abs(sample - eta_0))
psi_i = np.where(sample - eta_0 > 0, 1, 0)

sum(ri)  # 78.0
w_plus = sum(psi_i * ri)
w_minus = sum((1 - psi_i) * ri) # sum(ri) - w_plus
print(w_plus, w_minus)  # 67.0 11.0

# wilcoxon ê²€ì • í†µê³„ëŸ‰ì„ ê³„ì‚°í•´ë³´ì
stat, pval = wilcoxon(sample - eta_0, alternative='two-sided')
stat, pval  # 11.0  0.0268
# ê¸°ê° ê°€ëŠ¥


# 
# ì˜ˆì‹œ (2í‘œë³¸ ê²€ì •)
# 2í‘œë³¸ ê²€ì •ì€ ë‘ ì§‘ë‹¨ì˜ ì¤‘ì•™ê°’ì´ ê°™ì€ì§€ë¥¼ ê²€ì •í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

# U = min(U1, U2)
# 1ë²ˆ ê·¸ë£¹: x11, x12, x13  5, 1, 3  (n1 = 3)
# 2ë²ˆ ê·¸ë£¹: x21, x22       7, 9     (n2 = 2)
# R1: x12, x13, x11, x21, x22
# eta1ì´ eta2ë³´ë‹¤ ì‘ì•„ì„œ, 1ë²ˆ ê·¸ë£¹ì´ ì „ë¶€ ì™¼ìª½ì— ìˆë‹¤.

#  ë“±ë¶„ì‚° ê°€ì •ì´ ê¹¨ì¡Œì„ ë•Œ 2í‘œë³¸ ê²€ì •
from scipy.stats import brunnermunzel



# ìœŒì½•ìŠ¨ ìˆœìœ„í•© ê²€ì •ì€ 1í‘œë³¸ tê²€ì •ê³¼ ë¹„ìŠ·í•˜ë‹¤.
# (with ë ˆë¹ˆê²€ì •)ë§¨íœ˜íŠ¸ë‹ˆ U ê²€ì •ì€ 2í‘œë³¸ tê²€ì •(with Fê²€ì •)ê³¼ ë¹„ìŠ·í•˜ë‹¤.
# (with ë ˆë¹ˆê²€ì •)BMê²€ì •ì€ 2í‘œë³¸ tê²€ì • (ë“±ë¶„ì‚° X) ê³¼ ë¹„ìŠ·í•˜ë‹¤.


# ëŒ€ì‘í‘œë³¸ ë¹„ëª¨ìˆ˜ ê²€ì •
# ëŒ€ì‘í‘œë³¸ì€ 2ê°œ ê·¸ë£¹ì´ ìˆëŠ” ë°ì´í„°ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ, ì‹¤ì œë¡œëŠ” 1ê°œ ê·¸ë£¹ì˜ ë°ì´í„°ì…ë‹ˆë‹¤.




'''

ì—°ìŠµë¬¸ì œ

'''
import pandas as pd
import numpy as np

# 1ë²ˆ
brand_a = [35.2, 35.5, 35.6, 35.7, 35.8]
brand_b = [36.2, 37.0, 38.2, 38.0, 39.5]
data = pd.DataFrame({
    'Product': ['A'] * 5 + ['B'] * 5,
    'Quantity': brand_a + brand_b
})

# ë‘ ì œí’ˆ ë¸Œëœë“œ ê°„ í¬ì¥ ë‹¨ìœ„ë‹¹ ì‹¤ì œ ì¤‘ëŸ‰ ì°¨ì´ê°€ ìˆëŠ”ì§€ ì•Œì•„ë³´ê¸° ìœ„í•´ 
# ë¹„ëª¨ìˆ˜ ê²€ì •ì„ ì‹¤ì‹œí•˜ì‹œì˜¤.

from scipy.stats import levene, mannwhitneyu
stat, pval = levene(brand_a, brand_b)
pval < 0.05
# ë™ë¶„ì‚°ì„± ë§Œì¡± => ë…ë¦½ 2í‘œë³¸ tê²€ì • => ë§¨íœ˜íŠ¸ë‹ˆ U ê²€ì •

stat, p = mannwhitneyu(brand_a, brand_b, alternative='two-sided')
p < 0.05 # True
# ê·€ë¬´ê°€ì„¤ ê¸°ê°: ë‘ ë¸Œëœë“œ ê°„ ì‹¤ì œ ì¤‘ëŸ‰ì°¨ì´ê°€ ìˆë‹¤.





# 2ë²ˆ
# ë°ì´í„° ì„¤ëª…

# Trained : í›ˆë ¨ì„ ë°›ì€ ê·¸ë£¹ì˜ ì‹œí—˜ ì ìˆ˜
# Untrained : í›ˆë ¨ì„ ë°›ì§€ ì•Šì€ ê·¸ë£¹ì˜ ì‹œí—˜ ì ìˆ˜ (ê°™ì€ ìŒì—ì„œ ì¶”ì¶œ)
trained = np.array([115, 123, 137, 140, 130])
untrained = np.array([113, 119, 130, 134, 125])

from scipy.stats import wilcoxon

stat, pval = wilcoxon(trained, untrained)
pval < 0.05
# ê·€ë¬´ê°€ì„¤ ê¸°ê° X
# í›ˆë ¨ì„ ë°›ì€ ê·¸ë£¹ê³¼ ë°›ì§€ ì•Šì€ ê·¸ë£¹ê³¼ ì°¨ì´ê°€ ì—†ë‹¤.




# 3ë²ˆ

# ë°ì´í„° ì„¤ëª…

# Group : í‰ê°€ ê·¸ë£¹ (ì „ë¬¸ê°€, ì´ˆê¸‰ì, í•™ìƒ)
# Accuracy : í…ŒìŠ¤íŠ¸ ì •ë‹µ ìˆ˜

data = {
    'Experts': [82, 80, 85, 83, 88],
    'Novices': [77, 70, 74, 79, 73],
    'Students': [68, 72, 75, 73, 70]
}
df = pd.DataFrame(data)

from scipy.stats import kruskal
stat, pval = kruskal(df['Experts'], df['Novices'], df['Students'])
pval < 0.05 # True
# ì„¸ ì§‘ë‹¨ ê°„ ì°¨ì´ O




# 4ë²ˆ
# ë°ì´í„° ì„¤ëª…

# DrugA, DrugB : ë‘ ê°€ì§€ ì•½ë¬¼ì„ ë³µìš©í•œ í›„ ë°˜ì‘ ì‹œê°„ (ì´ˆ)
drugA = [1.82, 2.12, 1.74, 2.10, 1.65, 1.91, 2.45]
drugB = [2.22, 2.48, 2.15, 2.68, 2.60, 4.65]
stat, pval = levene(drugA, drugB)
pval < 0.05 # ë“±ë¶„ì‚°ì„± ë§Œì¡±

stat, pval = mannwhitneyu(drugA, drugB, alternative='two-sided')
pval < 0.05     # True
# ë‘ ì•½ë¬¼ê°„ ë°˜ì‘ ì‹œê°„ ì°¨ì´ê°€ ìœ ì˜ë¯¸í•˜ë‹¤.